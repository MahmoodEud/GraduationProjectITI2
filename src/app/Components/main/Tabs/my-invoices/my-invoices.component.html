<div class="container-fluid px-2 px-md-4 py-3 py-md-4 ">
  <!-- العنوان الرئيسي -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div class="d-flex align-items-center">
      <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
           style="width: 48px; height: 48px;">
        <i class="fa-solid fa-receipt text-white fs-5"></i>
      </div>
      <div>
        <h4 class="mb-1 fw-bold text-dark">مدفوعاتي</h4>
        <p class="text-muted mb-0 small">إدارة ومتابعة جميع المدفوعات</p>
      </div>
    </div>
    <div class="d-none d-md-block">
      <div class="badge bg-light text-dark px-3 py-2">
        <i class="fa-solid fa-receipt me-1"></i>
        إجمالي: {{ rows().length }}
      </div>
    </div>
  </div>

  <!-- رسائل الحالة -->
  @if (error()) {
    <div class="alert alert-danger border-0 shadow-sm mb-4" role="alert">
      <div class="d-flex align-items-center">
        <i class="fa-solid fa-exclamation-triangle me-2 fs-5"></i>
        <div>
          <strong>خطأ!</strong>
          <span class="d-block d-sm-inline">{{ error() }}</span>
        </div>
      </div>
    </div>
  }

  @if (loading()) {
    <div class="alert alert-info border-0 shadow-sm mb-4" role="alert">
      <div class="d-flex align-items-center">
        <i class="fa-solid fa-spinner fa-spin me-2 fs-5"></i>
        <span>جاري التحميل...</span>
        <div class="spinner-border spinner-border-sm ms-auto" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  }

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-gradient" 
         style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
      <div class="d-flex align-items-center">
        <i class="fa-solid fa-filter text-primary me-2"></i>
        <h6 class="mb-0 fw-bold">البحث والفلترة</h6>
        <button class="btn btn-sm btn-outline-secondary ms-auto" 
                type="button" 
                data-bs-toggle="collapse" 
                data-bs-target="#searchFilters">
          <i class="fa-solid fa-chevron-down"></i>
        </button>
      </div>
    </div>
    <div class="card-body p-3 p-md-4 collapse show" id="searchFilters">
      <div class="row g-3 align-items-end">
        
        <!-- بحث (رقم/ملاحظات) -->
        <div class="col-12 col-lg-3">
          <label class="form-label fw-semibold mb-2">
            <i class="fa-solid fa-magnifying-glass text-primary me-1"></i>
            بحث (رقم/ملاحظات)
          </label>
          <div class="input-group">
            <span class="input-group-text bg-light border-0">
              <i class="fa-solid fa-search text-muted"></i>
            </span>
            <input class="form-control border-0 shadow-sm" 
                   type="search"
                   style="background-color: #f8f9fa;"
                   [ngModel]="search()" 
                   (ngModelChange)="search.set($event)"
                   placeholder="ابحث برقم الفاتورة أو الملاحظات">
          </div>
        </div>

        <!-- الحالة -->
        <div class="col-6 col-lg-2">
          <label class="form-label fw-semibold mb-2">
            <i class="fa-solid fa-flag text-warning me-1"></i>
            الحالة
          </label>
          <select class="form-select border-0 shadow-sm" 
                  style="background-color: #f8f9fa;"
                  [ngModel]="status()" 
                  (ngModelChange)="status.set($event)">
            <option value="all">جميع الحالات</option>
            <option value="Draft">مسودة</option>
            <option value="Sent">مرسلة</option>
            <option value="Paid">مدفوعة</option>
            <option value="Cancelled">ملغية</option>
          </select>
        </div>

        <!-- من تاريخ -->
        <div class="col-6 col-lg-2">
          <label class="form-label fw-semibold mb-2">
            <i class="fa-solid fa-calendar text-info me-1"></i>
            من تاريخ
          </label>
          <input type="date" 
                 class="form-control border-0 shadow-sm" 
                 style="background-color: #f8f9fa;"
                 [ngModel]="dateFrom()" 
                 (ngModelChange)="dateFrom.set($event)">
        </div>

        <!-- إلى تاريخ -->
        <div class="col-6 col-lg-2">
          <label class="form-label fw-semibold mb-2">
            <i class="fa-solid fa-calendar text-info me-1"></i>
            إلى تاريخ
          </label>
          <input type="date" 
                 class="form-control border-0 shadow-sm" 
                 style="background-color: #f8f9fa;"
                 [ngModel]="dateTo()" 
                 (ngModelChange)="dateTo.set($event)">
        </div>

        <!-- غير مدفوعة فقط -->
        <div class="col-6 col-lg-2">
          <label class="form-label fw-semibold mb-2">
            <i class="fa-solid fa-clock text-secondary me-1"></i>
            خيارات إضافية
          </label>
          <div class="form-check form-switch">
            <input id="onlyUnpaid" 
                   class="form-check-input" 
                   type="checkbox" 
                   role="switch"
                   [ngModel]="onlyUnpaid()" 
                   (ngModelChange)="onlyUnpaid.set($event)">
            <label class="form-check-label fw-semibold" for="onlyUnpaid">
              غير مدفوعة فقط
            </label>
          </div>
        </div>

        <!-- زر مسح الفلاتر -->
        <div class="col-12 col-lg-1">
          <button class="btn btn-outline-secondary shadow-sm w-100" 
                  type="button"
                  title="مسح الفلاتر">
            <i class="fa-solid fa-eraser me-1 d-lg-none"></i>
            <span class="d-lg-none">مسح</span>
            <i class="fa-solid fa-eraser d-none d-lg-inline"></i>
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- جدول النتائج -->
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-gradient d-flex align-items-center justify-content-between" 
         style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
      <div class="d-flex align-items-center">
        <i class="fa-solid fa-table text-success me-2"></i>
        <h6 class="mb-0 fw-bold">قائمة الفواتير</h6>
      </div>
      <div class="d-flex align-items-center gap-3">
        <span class="badge bg-light text-dark">{{ rows().length }} فاتورة</span>
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                  type="button" 
                  data-bs-toggle="dropdown">
            <i class="fa-solid fa-download me-1"></i>
            تصدير
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#"><i class="fa-solid fa-file-excel me-1"></i> Excel</a></li>
            <li><a class="dropdown-item" href="#"><i class="fa-solid fa-file-pdf me-1"></i> PDF</a></li>
          </ul>
        </div>
      </div>
    </div>
    
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light sticky-top">
            <tr>
              <th class="px-3 py-3 fw-bold">
                <i class="fa-solid fa-hashtag text-muted me-1"></i>
                #
              </th>
              <th class="px-3 py-3 fw-bold">
                <i class="fa-solid fa-file-invoice text-primary me-1"></i>
                رقم الفاتورة
              </th>
              <th class="px-3 py-3 fw-bold d-none d-md-table-cell">
                <i class="fa-solid fa-book text-success me-1"></i>
                الكورس
              </th>
              <th class="px-3 py-3 fw-bold">
                <i class="fa-solid fa-dollar-sign text-warning me-1"></i>
                المبلغ
              </th>
              <th class="px-3 py-3 fw-bold">
                <i class="fa-solid fa-flag text-danger me-1"></i>
                الحالة
              </th>
              <th class="px-3 py-3 fw-bold d-none d-lg-table-cell">
                <i class="fa-solid fa-clock text-secondary me-1"></i>
                التاريخ
              </th>
              <th class="px-3 py-3 fw-bold text-center">
                <i class="fa-solid fa-paperclip text-muted me-1"></i>
                مرفق
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let it of rows(); let i = index" 
                class="border-bottom">
              
              <!-- ID -->
              <td class="px-3 py-3">
                <span class="badge bg-light text-dark px-2 py-1">
                  {{ it.id }}
                </span>
              </td>

              <!-- رقم الفاتورة -->
              <td class="px-3 py-3">
                @if (it.invoiceNo) {
                  <div class="fw-bold text-primary">{{ it.invoiceNo }}</div>
                } @else {
                  <span class="text-muted">—</span>
                }
              </td>

              <!-- الكورس -->
              <td class="px-3 py-3 d-none d-md-table-cell">
                @if (it.courseId) {
                  <div class="d-flex align-items-center">
                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-2" 
                         style="width: 24px; height: 24px; min-width: 24px;">
                      <i class="fa-solid fa-book text-white" style="font-size: 10px;"></i>
                    </div>
                    <span class="fw-semibold">{{ it.courseId }}</span>
                  </div>
                } @else {
                  <span class="text-muted">—</span>
                }
              </td>

              <!-- المبلغ -->
              <td class="px-3 py-3">
                <div class="fw-bold text-success">
                  {{ it.amount }}
                  <small class="text-muted">{{ it.currency }}</small>
                </div>
              </td>

              <!-- الحالة -->
              <td class="px-3 py-3">
                <span [class]="statusBadge(it.status)" 
                      class="badge px-2 py-1">
                  {{ it.status }}
                </span>
              </td>

              <!-- التاريخ -->
              <td class="px-3 py-3 d-none d-lg-table-cell">
                <div class="small">
                  <div class="fw-semibold">
                    {{ (it.updatedAt || it.createdAt) | date:'dd/MM/yyyy':'Africa/Cairo' }}
                  </div>
                  <div class="text-muted">
                    {{ (it.updatedAt || it.createdAt) | date:'HH:mm':'Africa/Cairo' }}
                  </div>
                </div>
              </td>

              <!-- المرفق -->
              <td class="px-3 py-3 text-center">
                @if (it.attachmentPath) {
                  <a [href]="fileUrl(it.attachmentPath)" 
                     target="_blank" 
                     class="btn btn-sm btn-outline-primary">
                    <i class="fa-solid fa-eye me-1"></i>
                    عرض
                  </a>
                } @else {
                  <span class="text-muted">—</span>
                }
              </td>

            </tr>

            @if (rows().length === 0) {
              <tr>
                <td colspan="7" class="text-center py-5">
                  <div class="d-flex flex-column align-items-center">
                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mb-3" 
                         style="width: 64px; height: 64px;">
                      <i class="fa-solid fa-search text-muted fs-4"></i>
                    </div>
                    <h6 class="text-muted mb-2">لا توجد فواتير مطابقة</h6>
                    <p class="text-muted small mb-0">جرب تغيير معايير البحث</p>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
