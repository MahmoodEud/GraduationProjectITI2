<!-- change-password.component.html -->
<div class="container-fluid py-3 mt-5 py-md-4" dir="rtl">
  <div class="row justify-content-center">
    <div class="col-12 col-sm-11 col-md-9 col-lg-7 col-xl-6 col-xxl-5">
      <div class="card shadow border-0 rounded-3">
        <div class="card-header bg-primary text-center py-3">
          <h4 class="mb-0 text-white fw-bold">
            <i class="bi bi-shield-lock me-2 fs-5"></i>
            تغيير كلمة المرور
          </h4>
        </div>

        <div class="card-body px-3 px-md-4 py-4">
          <!-- Error Alert -->
          @if (errorMsg) {
            <div class="alert alert-danger alert-dismissible d-flex align-items-start mb-4" role="alert">
              <i class="bi bi-exclamation-triangle-fill me-2 mt-1 text-danger"></i>
              <div class="flex-grow-1">{{ errorMsg }}</div>
            </div>
          }

          <!-- Success Alert -->
          @if (successMsg) {
            <div class="alert alert-success alert-dismissible d-flex align-items-start mb-4" role="alert">
              <i class="bi bi-check-circle-fill me-2 mt-1 text-success"></i>
              <div class="flex-grow-1">{{ successMsg }}</div>
            </div>
          }

          <form #changePasswordForm="ngForm" (ngSubmit)="submit(changePasswordForm)" autocomplete="off" novalidate>
            <div class="row g-3 g-md-4">
              
              <!-- Current Password -->
              <div class="col-12">
                <label for="currentPassword" class="form-label fw-semibold mb-2">
                  <i class="bi bi-key me-2 text-primary"></i>
                  كلمة المرور الحالية
                </label>
                <div class="input-group input-group-lg">
                  <input 
                    [type]="showCurrentPassword ? 'text' : 'password'"
                    class="form-control border-2 pe-5"
                    id="currentPassword"
                    name="currentPassword"
                    [(ngModel)]="model.currentPassword"
                    required
                    #currentPassword="ngModel"
                    autocomplete="current-password"
                    [disabled]="isLoading"
                    [class.is-invalid]="currentPassword.invalid && currentPassword.touched"
                    placeholder="أدخل كلمة المرور الحالية">
                  <button 
                    type="button" 
                    class="btn btn-outline-secondary password-toggle position-absolute top-50 end-0 translate-middle-y me-2 border-0 bg-transparent z-3"
                    style="width: 40px; height: 40px;"
                    [disabled]="isLoading"
                    (click)="togglePasswordVisibility('current')">
                    <i [class]="showCurrentPassword ? 'bi bi-eye-slash text-muted' : 'bi bi-eye text-muted'" class="fs-6"></i>
                  </button>
                </div>
                @if (currentPassword.invalid && currentPassword.touched) {
                  <div class="invalid-feedback d-block">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    يرجى إدخال كلمة المرور الحالية
                  </div>
                }
              </div>

              <!-- New Password -->
              <div class="col-12">
                <label for="newPassword" class="form-label fw-semibold mb-2">
                  <i class="bi bi-shield-check me-2 text-success"></i>
                  كلمة المرور الجديدة
                </label>
                <div class="input-group input-group-lg">
                  <input 
                    [type]="showNewPassword ? 'text' : 'password'"
                    class="form-control border-2 pe-5"
                    id="newPassword"
                    name="newPassword"
                    [(ngModel)]="model.newPassword"
                    required
                    minlength="8"
                    #newPassword="ngModel"
                    autocomplete="new-password"
                    [disabled]="isLoading"
                    [class.is-invalid]="newPassword.invalid && newPassword.touched"
                    placeholder="أدخل كلمة المرور الجديدة (8 أحرف على الأقل)">
                  <button 
                    type="button" 
                    class="btn btn-outline-secondary password-toggle position-absolute top-50 end-0 translate-middle-y me-2 border-0 bg-transparent z-3"
                    style="width: 40px; height: 40px;"
                    [disabled]="isLoading"
                    (click)="togglePasswordVisibility('new')">
                    <i [class]="showNewPassword ? 'bi bi-eye-slash text-muted' : 'bi bi-eye text-muted'" class="fs-6"></i>
                  </button>
                </div>
                @if (newPassword.invalid && newPassword.touched) {
                  <div class="invalid-feedback d-block">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    @if (newPassword.errors?.['required']) {
                      <span>يرجى إدخال كلمة المرور الجديدة</span>
                    }
                    @if (newPassword.errors?.['minlength']) {
                      <span>كلمة المرور يجب أن تكون 8 أحرف على الأقل</span>
                    }
                  </div>
                }
                <!-- Password Strength Indicator -->
                <div class="mt-2">
                  <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    يجب أن تحتوي كلمة المرور على 8 أحرف على الأقل
                  </small>
                </div>
              </div>

              <!-- Confirm Password -->
              <div class="col-12">
                <label for="confirmPassword" class="form-label fw-semibold mb-2">
                  <i class="bi bi-shield-check me-2 text-warning"></i>
                  تأكيد كلمة المرور الجديدة
                </label>
                <div class="input-group input-group-lg">
                  <input 
                    [type]="showConfirmPassword ? 'text' : 'password'"
                    class="form-control border-2 pe-5"
                    id="confirmPassword"
                    name="confirmPassword"
                    [(ngModel)]="model.confirmPassword"
                    required
                    #confirmPassword="ngModel"
                    autocomplete="new-password"
                    [disabled]="isLoading"
                    [class.is-invalid]="(confirmPassword.invalid && confirmPassword.touched) || 
                                         (confirmPassword.valid && model.newPassword !== model.confirmPassword && model.confirmPassword !== '')"
                    placeholder="أعد إدخال كلمة المرور الجديدة">
                  <button 
                    type="button" 
                    class="btn btn-outline-secondary password-toggle position-absolute top-50 end-0 translate-middle-y me-2 border-0 bg-transparent z-3"
                    style="width: 40px; height: 40px;"
                    [disabled]="isLoading"
                    (click)="togglePasswordVisibility('confirm')">
                    <i [class]="showConfirmPassword ? 'bi bi-eye-slash text-muted' : 'bi bi-eye text-muted'" class="fs-6"></i>
                  </button>
                </div>
                @if ((confirmPassword.invalid && confirmPassword.touched) || 
                     (confirmPassword.valid && model.newPassword !== model.confirmPassword && model.confirmPassword !== '')) {
                  <div class="invalid-feedback d-block">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    @if (confirmPassword.errors?.['required']) {
                      <span>يرجى تأكيد كلمة المرور</span>
                    }
                    @if (model.newPassword !== model.confirmPassword && model.confirmPassword !== '') {
                      <span>كلمات المرور غير متطابقة</span>
                    }
                  </div>
                }
                <!-- Password Match Indicator -->
                @if (model.newPassword && model.confirmPassword && model.newPassword === model.confirmPassword) {
                  <div class="mt-2">
                    <small class="text-success">
                      <i class="bi bi-check-circle me-1"></i>
                      كلمات المرور متطابقة
                    </small>
                  </div>
                }
              </div>
            </div>

            <hr class="my-4 border-2">

            <div class="d-flex gap-2 gap-md-3 justify-content-end flex-column-reverse flex-sm-row">
              <button 
                type="button" 
                class="btn btn-outline-secondary btn-lg px-4"
                [disabled]="isLoading"
                (click)="cancel()">
                <i class="bi bi-x-circle me-2"></i>
                إلغاء
              </button>
              <button 
                type="submit" 
                class="btn btn-primary btn-lg px-4"
                [disabled]="isLoading || !changePasswordForm.valid || model.newPassword !== model.confirmPassword">
                @if (isLoading) {
                  <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  <span>جاري الحفظ...</span>
                } @else {
                  <i class="bi bi-check-circle me-2"></i>
                  <span>حفظ التعديلات</span>
                }
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>