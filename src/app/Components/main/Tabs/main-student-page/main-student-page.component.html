<div class="container-fluid px-2 px-md-4 py-5 py-md-4  mb-5">
  @if (loading()) {
    <div class="alert alert-info d-flex align-items-center mb-5" role="alert">
      <i class="fa-solid fa-spinner fa-spin me-2 fs-5"></i> 
      <span>جارٍ التحميل...</span>
    </div>
  } @else if (error()) {
    <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
      <i class="fa-solid fa-triangle-exclamation me-2 fs-5"></i> 
      <span>{{ error() }}</span>
    </div>
  } @else {
    <div class="row mb-5">
      <div class="col-12">
        <h2 class="h3 mb-1 text-primary fw-bold">
          <i class="fa-solid fa-chart-line me-2"></i>
          لوحة تحكم الاختبارات
        </h2>
        <p class="text-muted mb-0">عرض شامل لأداء الطلاب في الاختبارات</p>
      </div>
    </div>

    <div class="row g-2 g-md-3 mb-4">
      <div class="col-6 col-lg-3">
        <div class="card h-100 border-0 shadow-sm kpi-card bg-primary bg-gradient text-white">
          <div class="card-body text-center p-3">
            <i class="fa-solid fa-list-check fs-2 mb-2 opacity-75"></i>
            <div class="kpi-label small mb-1 text-white">إجمالي المحاولات</div>
            <div class="kpi-value h4 mb-0 fw-bold">{{ overview()?.totalAttempts ?? 0 }}</div>
          </div>
        </div>
      </div>
      
      <div class="col-6 col-lg-3">
        <div class="card h-100 border-0 shadow-sm kpi-card bg-info bg-gradient text-white">
          <div class="card-body text-center p-3">
            <i class="fa-solid fa-clipboard-list fs-2 mb-2 opacity-75"></i>
            <div class="kpi-label small mb-1 text-white">عدد التقييمات</div>
            <div class="kpi-value h4 mb-0 fw-bold">{{ overview()?.distinctAssessments ?? 0 }}</div>
          </div>
        </div>
      </div>
      
      <div class="col-6 col-lg-3">
        <div class="card h-100 border-0 shadow-sm kpi-card bg-warning bg-gradient text-white">
          <div class="card-body text-center p-3">
            <i class="fa-solid fa-star fs-2 mb-2 opacity-75"></i>
            <div class="kpi-label small mb-1 text-white">متوسط الدرجة</div>
            <div class="kpi-value h4 mb-0 fw-bold">{{ overview()?.averageScore ?? 0 }}%</div>
          </div>
        </div>
      </div>
      
      <div class="col-6 col-lg-3">
        <div class="card h-100 border-0 shadow-sm kpi-card bg-success bg-gradient text-white">
          <div class="card-body text-center p-3">
            <i class="fa-solid fa-trophy fs-2 mb-2 opacity-75"></i>
            <div class="kpi-label small mb-1 text-white">نسبة النجاح</div>
            <div class="kpi-value h4 mb-0 fw-bold">{{ overview()?.passRate ?? 0 }}%</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-body p-3 p-md-4">
            <div class="row align-items-center g-3">
              
              <!-- Summary Stats -->
              <div class="col-12 col-lg-7">
                <h6 class="text-muted mb-2 fs-6">إجمالي الإجابات عبر كل المحاولات</h6>
                <div class="d-flex flex-wrap gap-2">
                  <span class="badge bg-success fs-6 px-3 py-2">
                    <i class="fa-solid fa-check me-1"></i>
                    صحيح: {{ overview()?.totalCorrect ?? 0 }}
                  </span>
                  <span class="badge bg-danger fs-6 px-3 py-2">
                    <i class="fa-solid fa-times me-1"></i>
                    خطأ: {{ overview()?.totalWrong ?? 0 }}
                  </span>
                  <span class="badge bg-primary fs-6 px-3 py-2">
                    <i class="fa-solid fa-chart-line me-1"></i>
                    تحسّن: {{ overview()?.improvementPoints ?? 0 }} نقطة
                  </span>
                </div>
              </div>

              <!-- Sparkline Chart -->
              <div class="col-12 col-lg-5">
                <div class="text-center">
                  <div class="spark-container p-3 rounded bg-light">
                    <svg class="w-100" height="60" viewBox="0 0 320 60" style="max-width: 300px;">
                      <defs>
                        <linearGradient id="sparkGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                          <stop offset="0%" style="stop-color:#007bff;stop-opacity:0.8" />
                          <stop offset="100%" style="stop-color:#28a745;stop-opacity:0.8" />
                        </linearGradient>
                      </defs>
                      <path [attr.d]="sparkPath(320,60,8)" 
                            fill="none" 
                            stroke="url(#sparkGradient)" 
                            stroke-width="3" 
                            stroke-linecap="round">
                      </path>
                    </svg>
                    <small class="text-muted d-block mt-1">اتجاه الدرجات الأخيرة</small>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-5 py-5">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-bottom-0 p-3 p-md-4">
            <h5 class="card-title mb-0 text-dark">
              <i class="fa-solid fa-table me-2"></i>
              سجل المحاولات
            </h5>
          </div>
          
          <div class="card-body p-3 p-md-4">
            
            <!-- Filters Row -->
            <div class="row g-2 g-md-3 mb-4">
              
              <!-- Search Input -->
              <div class="col-12 col-lg-6">
                <label class="form-label small text-muted mb-1">البحث</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="fa-solid fa-search text-muted"></i>
                  </span>
                  <input
                    class="form-control border-start-0"
                    type="search"
                    placeholder="ابحث باسم الكويز أو الامتحان..."
                    [ngModel]="search()"
                    (ngModelChange)="search.set($event)"
                  >
                </div>
              </div>

              <!-- Status Filter -->
              <div class="col-6 col-lg-3">
                <label class="form-label small text-muted mb-1">حالة النجاح</label>
                <select
                  class="form-select"
                  [ngModel]="status()"
                  (ngModelChange)="status.set($event)"
                >
                  <option value="all">جميع الحالات</option>
                  <option value="passed">ناجح فقط</option>
                  <option value="failed">راسب فقط</option>
                </select>
              </div>

              <!-- Sort Options -->
              <div class="col-6 col-lg-3">
                <label class="form-label small text-muted mb-1">ترتيب حسب</label>
                <div class="btn-group w-100" role="group">
                  <button 
                    type="button" 
                    class="btn btn-outline-primary btn-sm" 
                    [class.active]="sortKey()==='date'" 
                    (click)="toggleSort('date')"
                  >
                    التاريخ
                    <i class="fa-solid ms-1" 
                       [ngClass]="{
                         'fa-arrow-down': sortKey()==='date' && sortDir()==='desc', 
                         'fa-arrow-up': sortKey()==='date' && sortDir()==='asc',
                         'fa-sort': sortKey()!=='date'
                       }">
                    </i>
                  </button>
                  <button 
                    type="button" 
                    class="btn btn-outline-primary btn-sm" 
                    [class.active]="sortKey()==='score'" 
                    (click)="toggleSort('score')"
                  >
                    الدرجة
                    <i class="fa-solid ms-1" 
                       [ngClass]="{
                         'fa-arrow-down': sortKey()==='score' && sortDir()==='desc', 
                         'fa-arrow-up': sortKey()==='score' && sortDir()==='asc',
                         'fa-sort': sortKey()!=='score'
                       }">
                    </i>
                  </button>
                </div>
              </div>

            </div>

            <!-- Results Table -->
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="border-0 fw-semibold text-dark">
                      <i class="fa-solid fa-file-lines me-2 text-primary"></i>
                      الاختبار
                    </th>
                    <th class="border-0 fw-semibold text-dark text-center d-none d-sm-table-cell">
                      <i class="fa-solid fa-percent me-2 text-warning"></i>
                      الدرجة
                    </th>
                    <th class="border-0 fw-semibold text-dark text-center">
                      <i class="fa-solid fa-flag me-2 text-info"></i>
                      الحالة
                    </th>
                    <th class="border-0 fw-semibold text-dark text-center d-none d-md-table-cell">
                      <i class="fa-solid fa-calendar me-2 text-secondary"></i>
                      التاريخ
                    </th>
                    <th class="border-0 fw-semibold text-dark text-center">العمليات</th>
                  </tr>
                </thead>
                <tbody>
                  @for (r of rows(); track r.attemptId) {
                    <tr class="border-bottom">
                      <td class="fw-medium py-3">
                        <div class="d-flex flex-column">
                          <span class="text-dark mb-1">{{ r.assessmentName }}</span>
                          <!-- Mobile: Show score and date under title -->
                          <div class="d-sm-none">
                            <small class="text-muted">
                              {{ r.score }}% • {{ (r.submittedAt || r.startedAt) | date:'short':'Africa/Cairo' }}
                            </small>
                          </div>
                        </div>
                      </td>
                      
                      <td class="text-center py-3 d-none d-sm-table-cell">
                        <span class="badge bg-secondary bg-opacity-25 text-dark fs-6 px-2 py-1">
                          {{ r.score }}%
                        </span>
                      </td>
                      
                      <td class="text-center py-3">
                        <span [class]="statusBadge(r)" class="px-3 py-1 rounded-pill">
                          <i class="fa-solid me-1" 
                             [ngClass]="r.isPassed ? 'fa-check' : 'fa-times'">
                          </i>
                          {{ r.isPassed ? 'ناجح' : 'راسب' }}
                        </span>
                      </td>
                      
                      <td class="text-center py-3 d-none d-md-table-cell">
                        <small class="text-muted">
                          {{ (r.submittedAt || r.startedAt) | date:'short':'Africa/Cairo' }}
                        </small>
                      </td>
                      
                      <td class="text-center py-3">
                        <button 
                          class="btn btn-primary btn-sm px-3" 
                          (click)="goDetails(r)"
                          type="button"
                        >
                          <i class="fa-solid fa-eye me-1 d-none d-sm-inline"></i>
                          <span class="d-none d-sm-inline">عرض </span>التفاصيل
                        </button>
                      </td>
                    </tr>
                  }
                  @empty {
                    <tr>
                      <td colspan="5" class="text-center py-5 text-muted">
                        <div class="d-flex flex-column align-items-center">
                          <i class="fa-solid fa-inbox fs-1 mb-3 text-muted opacity-50"></i>
                          <h6 class="text-muted">لا توجد محاولات بعد</h6>
                          <p class="small text-muted mb-0">ستظهر المحاولات هنا بمجرد البدء في الاختبارات</p>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
    </div>

  }
</div>

