<div class="container-fluid py-4" dir="rtl">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-6 col-lg-8 col-md-10">
      <!-- Header -->
      <div class="text-center mb-4">
        <h2 class="display-6 text-primary mb-2">
          <i class="fas fa-user-cog me-3"></i>
          إعدادات المستخدم
        </h2>
        <p class="text-muted">تحديث بيانات وصلاحيات المستخدمين</p>
      </div>

      <div class="card border-0 shadow-lg">
        <div class="card-header bg-gradient-primary text-white text-center py-3">
          <h5 class="mb-0">
            <i class="fas fa-user-gear me-2"></i>
            إدارة إعدادات المستخدم
          </h5>
        </div>

        <div class="card-body p-4">
          <!-- Loading State -->
          @if (isLoading) {
            <div class="text-center py-4">
              <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">جاري التحميل...</span>
              </div>
              <p class="text-muted">جاري تحميل البيانات...</p>
            </div>
          }

          <!-- Error Message -->
          @if (errorMsg && !isLoading) {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle fa-lg me-3"></i>
                <div>
                  <strong>خطأ!</strong>
                  <div>{{ errorMsg }}</div>
                </div>
              </div>
            </div>
          }

          <!-- Success Message -->
          @if (successMsg && !isLoading) {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <div class="d-flex align-items-center">
                <i class="fas fa-check-circle fa-lg me-3"></i>
                <div>
                  <strong>تم بنجاح!</strong>
                  <div>{{ successMsg }}</div>
                </div>
              </div>
            </div>
          }

          <!-- Form -->
          <form #userSettingForm="ngForm" (ngSubmit)="submit(userSettingForm)" autocomplete="off" novalidate>
            
            <!-- User Selection -->
            <div class="mb-4">
              <label for="selectedUser" class="form-label fw-bold text-dark">
                <i class="fas fa-user me-2 text-primary"></i>
                اختر المستخدم
                <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <span class="input-group-text bg-light">
                  <i class="fas fa-users text-muted"></i>
                </span>
                <select
                  id="selectedUser"
                  class="form-select form-select-lg"
                  [(ngModel)]="selectedUserId"
                  name="selectedUser"
                  (ngModelChange)="onUserChange()"
                  required
                  [disabled]="isLoading"
                  [class.is-invalid]="userSettingForm.submitted && userSettingForm.controls['selectedUser'].errors">
                  <option value="">-- اختر المستخدم --</option>
                  @for (user of users; track user.id) {
                    <option [value]="user.id">
                      <span class="fw-bold">{{ user.name }}</span> 
                      <span class="text-muted">|| {{ user.userName }} ||</span>
                      <span class="badge bg-info">({{ user.role || 'غير محدد' }})</span>
                    </option>
                  }
                </select>
              </div>
              @if (userSettingForm.submitted && userSettingForm.controls['selectedUser'].errors?.['required']) {
                <div class="invalid-feedback d-block">
                  <i class="fas fa-exclamation-circle me-1"></i>
                  يرجى اختيار مستخدم
                </div>
              }
            </div>

            <div class="mb-4">
              <label for="newPassword" class="form-label fw-bold text-dark">
                <i class="fas fa-lock me-2 text-warning"></i>
                كلمة المرور الجديدة
                <span class="text-muted">(اختياري)</span>
              </label>
              <div class="input-group">
                <span class="input-group-text bg-light">
                  <i class="fas fa-key text-muted"></i>
                </span>
                <input
                  [type]="showNewPassword ? 'text' : 'password'"
                  id="newPassword"
                  class="form-control form-control-lg"
                  [(ngModel)]="newPassword"
                  name="newPassword"
                  placeholder="أدخل كلمة المرور الجديدة"
                  minlength="8"
                  [class.is-invalid]="userSettingForm.submitted && userSettingForm.controls['newPassword'].errors"
                />
                <button 
                  type="button" 
                  class="btn btn-outline-secondary" 
                  (click)="togglePasswordVisibility('new')"
                  tabindex="-1">
                  <i [class]="showNewPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                </button>
              </div>
              @if (userSettingForm.submitted && userSettingForm.controls['newPassword'].errors?.['minlength']) {
                <div class="invalid-feedback d-block">
                  <i class="fas fa-exclamation-circle me-1"></i>
                  كلمة المرور يجب أن تكون 8 أحرف على الأقل
                </div>
              }
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>
                كلمة المرور يجب أن تحتوي على الأقل 8 أحرف
              </div>
            </div>

            <!-- Confirm Password -->
            <div class="mb-4">
              <label for="confirmPassword" class="form-label fw-bold text-dark">
                <i class="fas fa-shield-alt me-2 text-success"></i>
                تأكيد كلمة المرور
                <span class="text-muted">(اختياري)</span>
              </label>
              <div class="input-group">
                <span class="input-group-text bg-light">
                  <i class="fas fa-check-double text-muted"></i>
                </span>
                <input
                  [type]="showConfirmPassword ? 'text' : 'password'"
                  id="confirmPassword"
                  class="form-control form-control-lg"
                  [(ngModel)]="confirmPassword"
                  name="confirmPassword"
                  placeholder="تأكيد كلمة المرور"
                  [class.is-invalid]="userSettingForm.submitted && (confirmPassword !== newPassword && newPassword)"
                />
                <button 
                  type="button" 
                  class="btn btn-outline-secondary" 
                  (click)="togglePasswordVisibility('confirm')"
                  tabindex="-1">
                  <i [class]="showConfirmPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                </button>
              </div>
              @if (userSettingForm.submitted && (confirmPassword !== newPassword && newPassword)) {
                <div class="invalid-feedback d-block">
                  <i class="fas fa-exclamation-circle me-1"></i>
                  كلمات المرور غير متطابقة
                </div>
              }
            </div>

            <!-- Role Selection -->
            <div class="mb-4">
              <label for="selectedRole" class="form-label fw-bold text-dark">
                <i class="fas fa-user-tag me-2 text-info"></i>
                اختر الدور
                <span class="text-muted">(اختياري)</span>
              </label>
              <div class="input-group">
                <span class="input-group-text bg-light">
                  <i class="fas fa-crown text-muted"></i>
                </span>
                <select
                  id="selectedRole"
                  class="form-select form-select-lg"
                  [(ngModel)]="selectedRole"
                  name="selectedRole"
                  [disabled]="isLoading"
                  [class.is-invalid]="userSettingForm.submitted && userSettingForm.controls['selectedRole'].errors">
                  <option value="">-- اختر الدور --</option>
                  @for (role of roles; track role) {
                    <option [value]="role">
                      <i class="fas fa-user-circle me-2"></i>
                      {{ role }}
                    </option>
                  }
                </select>
              </div>
              @if (userSettingForm.submitted && userSettingForm.controls['selectedRole'].errors?.['required']) {
                <div class="invalid-feedback d-block">
                  <i class="fas fa-exclamation-circle me-1"></i>
                  يرجى اختيار دور
                </div>
              }
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-3 justify-content-end pt-3 border-top">
              <button 
                type="button" 
                class="btn btn-outline-secondary btn-lg px-4" 
                (click)="resetForm()" 
                [disabled]="isLoading">
                <i class="fas fa-undo me-2"></i>
                إلغاء
              </button>
              <button 
                type="submit" 
                class="btn btn-primary btn-lg px-4" 
                [disabled]="isLoading">
                @if (isLoading) {
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  جاري الحفظ...
                } @else {
                  <i class="fas fa-save me-2"></i>
                  حفظ التعديلات
                }
              </button>
            </div>
          </form>

        </div>
      </div>

      <!-- Info Card -->
      <div class="card border-0 shadow-sm mt-4">
        <div class="card-body bg-light">
          <div class="row text-center">
            <div class="col-md-4 mb-3 mb-md-0">
              <div class="text-primary mb-2">
                <i class="fas fa-users fa-2x"></i>
              </div>
              <h6 class="fw-bold">إدارة المستخدمين</h6>
              <small class="text-muted">تحديث بيانات المستخدمين بسهولة</small>
            </div>
            <div class="col-md-4 mb-3 mb-md-0">
              <div class="text-success mb-2">
                <i class="fas fa-shield-alt fa-2x"></i>
              </div>
              <h6 class="fw-bold">الأمان</h6>
              <small class="text-muted">تشفير قوي لحماية كلمات المرور</small>
            </div>
            <div class="col-md-4">
              <div class="text-info mb-2">
                <i class="fas fa-user-tag fa-2x"></i>
              </div>
              <h6 class="fw-bold">الصلاحيات</h6>
              <small class="text-muted">إدارة أدوار وصلاحيات المستخدمين</small>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>